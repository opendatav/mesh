"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[3750],{6895:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"reference/install-configuration/providers/kubernetes/kubernetes-crd","title":"Kubernetes Custom Resources","description":"Configure the Kubernetes CRD provider that allows managing Mesh custom resources.","source":"@site/docs/reference/install-configuration/providers/kubernetes/kubernetes-crd.md","sourceDirName":"reference/install-configuration/providers/kubernetes","slug":"/reference/install-configuration/providers/kubernetes/kubernetes-crd","permalink":"/doc/docs/reference/install-configuration/providers/kubernetes/kubernetes-crd","draft":false,"unlisted":false,"editUrl":"https://github.com/opendatav/mesh/tree/main/packages/create-docusaurus/templates/shared/docs/reference/install-configuration/providers/kubernetes/kubernetes-crd.md","tags":[],"version":"current","frontMatter":{"title":"Kubernetes Custom Resources","description":"Configure the Kubernetes CRD provider that allows managing Mesh custom resources."},"sidebar":"tutorialSidebar","previous":{"title":"Nomad Service Discovery","permalink":"/doc/docs/reference/install-configuration/providers/hashicorp/nomad"},"next":{"title":"Mesh Kubernetes Gateway API Documentation","permalink":"/doc/docs/reference/install-configuration/providers/kubernetes/kubernetes-gateway"}}');var n=s(4848),i=s(8453);const l={title:"Kubernetes Custom Resources",description:"Configure the Kubernetes CRD provider that allows managing Mesh custom resources."},o=void 0,d={},c=[{value:"Requirements",id:"requirements",level:2},{value:"Configuration Example",id:"configuration-example",level:2},{value:"Configuration Options",id:"configuration-options",level:2},{value:"endpoint",id:"endpoint",level:3},{value:"Routing Configuration",id:"routing-configuration",level:2},{value:"List of Resources",id:"list-of-resources",level:2},{value:"Particularities",id:"particularities",level:2},{value:"Full Example",id:"full-example",level:2}];function a(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["Mesh provides some Kubernetes Custom Resources, such as ",(0,n.jsx)(t.code,{children:"IngressRoute"}),", ",(0,n.jsx)(t.code,{children:"Middleware"}),", etc."]}),"\n",(0,n.jsxs)(t.p,{children:["When using KubernetesCRD as a provider,\nMesh uses ",(0,n.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/",children:"Custom Resource Definition"})," to retrieve its routing configuration.\nMesh Custom Resource Definitions are ",(0,n.jsx)(t.a,{href:"#list-of-resources",children:"listed below"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["When Mesh is installed using the Helm Chart, by default, the provider ",(0,n.jsx)(t.code,{children:"kubernetesCRD"})," is enabled."]}),"\n",(0,n.jsx)(t.h2,{id:"requirements",children:"Requirements"}),"\n",(0,n.jsx)(t.p,{children:"When you install Mesh without using the Helm Chart, or when you are upgrading the stack using Helm, ensure that you satisfy the following requirements:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Add/update ",(0,n.jsx)(t.strong,{children:"all"})," the Mesh resources definitions"]}),"\n",(0,n.jsxs)(t.li,{children:["Add/update the ",(0,n.jsx)(t.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/rbac/",children:"RBAC"})," for the Mesh custom resources"]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"# Install Mesh Resource Definitions:\nkubectl apply -f https://raw.githubusercontent.com/Mesh/Mesh/v3.4/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml\n\n# Install RBAC for Mesh:\nkubectl apply -f https://raw.githubusercontent.com/Mesh/Mesh/v3.4/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml\n"})}),"\n",(0,n.jsx)(t.h2,{id:"configuration-example",children:"Configuration Example"}),"\n",(0,n.jsxs)(t.p,{children:["You can enable the ",(0,n.jsx)(t.code,{children:"kubernetesCRD"})," provider as detailed below:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"providers:\n  kubernetesCRD: {}\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[providers.kubernetesCRD]\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'tab="CLI"',children:"--providers.kubernetescrd=true\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="Helm Chart Values"',children:"## Values file\nproviders:\n  kubernetesCRD:\n    enabled: true\n"})}),"\n",(0,n.jsx)(t.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Field"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Default"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Required"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.providersThrottleDuration"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Minimum amount of time to wait for, after a configuration reload, before taking into account any new configuration refresh event.",(0,n.jsx)("br",{}),"If multiple events occur within this time, only the most recent one is taken into account, and all others are discarded.",(0,n.jsx)("br",{}),(0,n.jsx)(t.strong,{children:"This option cannot be set per provider, but the throttling algorithm applies to each of them independently."})]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"2s"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.endpoint"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Server endpoint URL.",(0,n.jsx)("br",{}),"More information ",(0,n.jsx)(t.a,{href:"#endpoint",children:"here"}),"."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:'""'}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.token"})}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"Bearer token used for the Kubernetes client configuration."}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:'""'}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.certAuthFilePath"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Path to the certificate authority file.",(0,n.jsx)("br",{}),"Used for the Kubernetes client configuration."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:'""'}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.namespaces"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Array of namespaces to watch.",(0,n.jsx)("br",{}),"If left empty, watch all namespaces."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"[]"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.labelselector"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Allow filtering on specific resource objects only using label selectors.",(0,n.jsx)("br",{}),"Only to Mesh ",(0,n.jsx)(t.a,{href:"#list-of-resources",children:"Custom Resources"})," (they all must match the filter).",(0,n.jsx)("br",{}),"No effect on Kubernetes ",(0,n.jsx)(t.code,{children:"Secrets"}),", ",(0,n.jsx)(t.code,{children:"EndpointSlices"})," and ",(0,n.jsx)(t.code,{children:"Services"}),".",(0,n.jsx)("br",{}),"See ",(0,n.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors",children:"label-selectors"})," for details."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:'""'}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.ingressClass"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Value of ",(0,n.jsx)(t.code,{children:"kubernetes.io/ingress.class"})," annotation that identifies resource objects to be processed.",(0,n.jsx)("br",{}),"If empty, resources missing the annotation, having an empty value, or the value ",(0,n.jsx)(t.code,{children:"Mesh"})," are processed."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:'""'}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.throttleDuration"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Minimum amount of time to wait between two Kubernetes events before producing a new configuration.",(0,n.jsx)("br",{}),"This prevents a Kubernetes cluster that updates many times per second from continuously changing your Mesh configuration.",(0,n.jsx)("br",{}),"If empty, every event is caught."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"0s"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.allowEmptyServices"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Allows creating a route to reach a service that has no endpoint available.",(0,n.jsx)("br",{}),"It allows Mesh to handle the requests and responses targeting this service (applying middleware or observability operations) before returning a ",(0,n.jsx)(t.code,{children:"503"})," HTTP Status."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"false"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.allowCrossNamespace"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Allows the ",(0,n.jsx)(t.code,{children:"IngressRoutes"})," to reference resources in namespaces other than theirs."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"false"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.allowExternalNameServices"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Allows the ",(0,n.jsx)(t.code,{children:"IngressRoutes"})," to reference ExternalName services."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"false"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.nativeLBByDefault"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Allow using the Kubernetes Service load balancing between the pods instead of the one provided by Mesh for every ",(0,n.jsx)(t.code,{children:"IngressRoute"})," by default.",(0,n.jsx)("br",{}),"It can br overridden in the ",(0,n.jsx)(t.a,{href:"/doc/docs/routing/services/#serverstransport",children:(0,n.jsx)(t.code,{children:"ServerTransport"})}),"."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"false"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"providers.kubernetesCRD.disableClusterScopeResources"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Prevent from discovering cluster scope resources (",(0,n.jsx)(t.code,{children:"IngressClass"})," and ",(0,n.jsx)(t.code,{children:"Nodes"}),").",(0,n.jsx)("br",{}),"By doing so, it alleviates the requirement of giving Mesh the rights to look up for cluster resources.",(0,n.jsx)("br",{}),"Furthermore, Mesh will not handle IngressRoutes with IngressClass references, therefore such Ingresses will be ignored (please note that annotations are not affected by this option).",(0,n.jsx)("br",{}),"This will also prevent from using the ",(0,n.jsx)(t.code,{children:"NodePortLB"})," options on services."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"false"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]})]})]}),"\n",(0,n.jsx)(t.h3,{id:"endpoint",children:"endpoint"}),"\n",(0,n.jsx)(t.p,{children:"The Kubernetes server endpoint URL."}),"\n",(0,n.jsxs)(t.p,{children:["When deployed into Kubernetes, Mesh reads the environment variables ",(0,n.jsx)(t.code,{children:"KUBERNETES_SERVICE_HOST"})," and ",(0,n.jsx)(t.code,{children:"KUBERNETES_SERVICE_PORT"})," or ",(0,n.jsx)(t.code,{children:"KUBECONFIG"})," to construct the endpoint."]}),"\n",(0,n.jsxs)(t.p,{children:["The access token is looked up in ",(0,n.jsx)(t.code,{children:"/var/run/secrets/kubernetes.io/serviceaccount/token"})," and the SSL CA certificate in ",(0,n.jsx)(t.code,{children:"/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"}),".\nBoth are mounted automatically when deployed inside Kubernetes."]}),"\n",(0,n.jsx)(t.p,{children:"The endpoint may be specified to override the environment variable values inside a cluster."}),"\n",(0,n.jsxs)(t.p,{children:["When the environment variables are not found, Mesh tries to connect to the Kubernetes API server with an external-cluster client.\nIn this case, the endpoint is required.\nSpecifically, it may be set to the URL used by ",(0,n.jsx)(t.code,{children:"kubectl proxy"})," to connect to a Kubernetes cluster using the granted authentication and authorization of the associated kubeconfig."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:'providers:\n  kubernetesCRD:\n    endpoint: "http://localhost:8080"\n    # ...\n'})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[providers.kubernetesCRD]\n  endpoint = "http://localhost:8080"\n  # ...\n'})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",metastring:'tab="CLI"',children:"--providers.kubernetesCRD.endpoint=http://localhost:8080\n"})}),"\n",(0,n.jsx)(t.h2,{id:"routing-configuration",children:"Routing Configuration"}),"\n",(0,n.jsxs)(t.p,{children:["See the dedicated section in ",(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd",children:"routing"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"list-of-resources",children:"List of Resources"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Resource"}),(0,n.jsx)(t.th,{children:"Purpose"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-ingressroute",children:"IngressRoute"})}),(0,n.jsx)(t.td,{children:"HTTP Routing"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/middlewares/http/overview",children:"Middleware"})}),(0,n.jsx)(t.td,{children:"Tweaks the HTTP requests before they are sent to your service"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-Meshservice",children:"MeshService"})}),(0,n.jsx)(t.td,{children:"Abstraction for HTTP loadbalancing/mirroring"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-tlsoption",children:"TLSOptions"})}),(0,n.jsx)(t.td,{children:"Allows configuring some parameters of the TLS connection"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-tlsstore",children:"TLSStores"})}),(0,n.jsx)(t.td,{children:"Allows configuring the default TLS store"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-serverstransport",children:"ServersTransport"})}),(0,n.jsx)(t.td,{children:"Allows configuring the transport between Mesh and the backends"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-ingressroutetcp",children:"IngressRouteTCP"})}),(0,n.jsx)(t.td,{children:"TCP Routing"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-middlewaretcp",children:"MiddlewareTCP"})}),(0,n.jsx)(t.td,{children:"Tweaks the TCP requests before they are sent to your service"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-serverstransporttc",children:"ServersTransportTCP"})}),(0,n.jsx)(t.td,{children:"Allows configuring the transport between Mesh and the backends"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"/doc/docs/routing/providers/kubernetes-crd#kind-ingressrouteudp",children:"IngressRouteUDP"})}),(0,n.jsx)(t.td,{children:"UDP Routing"})]})]})]}),"\n",(0,n.jsx)(t.h2,{id:"particularities",children:"Particularities"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["The usage of ",(0,n.jsx)(t.code,{children:"name"})," ",(0,n.jsx)(t.strong,{children:"and"})," ",(0,n.jsx)(t.code,{children:"namespace"})," to refer to another Kubernetes resource."]}),"\n",(0,n.jsxs)(t.li,{children:["The usage of ",(0,n.jsx)(t.a,{href:"https://kubernetes.io/docs/concepts/configuration/secret/",children:"secret"})," for sensitive data (TLS certificates and credentials)."]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"full-example",children:"Full Example"}),"\n",(0,n.jsxs)(t.p,{children:["For additional information, refer to the ",(0,n.jsx)(t.a,{href:"/doc/docs/user-guides/crd-acme/",children:"full example"})," with Let's Encrypt."]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(a,{...e})}):a(e)}},8453:(e,t,s)=>{s.d(t,{R:()=>l,x:()=>o});var r=s(6540);const n={},i=r.createContext(n);function l(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:l(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);