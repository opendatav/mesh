"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[2436],{1883:(e,t,r)=>{r.d(t,{A:()=>i});const i=r.p+"assets/images/circuitbreaker-7c10faa20fac8fb86b6a16909a388265.png"},2072:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"reference/routing-configuration/http/middlewares/circuitbreaker","title":"Mesh CircuitBreaker Documentation","description":"The HTTP circuit breaker in Mesh Proxy prevents stacking requests to unhealthy Services, resulting in cascading failures. Read the technical documentation.","source":"@site/docs/reference/routing-configuration/http/middlewares/circuitbreaker.md","sourceDirName":"reference/routing-configuration/http/middlewares","slug":"/reference/routing-configuration/http/middlewares/circuitbreaker","permalink":"/doc/docs/reference/routing-configuration/http/middlewares/circuitbreaker","draft":false,"unlisted":false,"editUrl":"https://github.com/opendatav/mesh/tree/main/packages/create-docusaurus/templates/shared/docs/reference/routing-configuration/http/middlewares/circuitbreaker.md","tags":[],"version":"current","frontMatter":{"title":"Mesh CircuitBreaker Documentation","description":"The HTTP circuit breaker in Mesh Proxy prevents stacking requests to unhealthy Services, resulting in cascading failures. Read the technical documentation."},"sidebar":"tutorialSidebar","previous":{"title":"Mesh Chain Middleware Documentation","permalink":"/doc/docs/reference/routing-configuration/http/middlewares/chain"},"next":{"title":"Mesh Compress Documentation","permalink":"/doc/docs/reference/routing-configuration/http/middlewares/compress"}}');var n=r(4848),s=r(8453);const c={title:"Mesh CircuitBreaker Documentation",description:"The HTTP circuit breaker in Mesh Proxy prevents stacking requests to unhealthy Services, resulting in cascading failures. Read the technical documentation."},l=void 0,o={},a=[{value:"Configuration Examples",id:"configuration-examples",level:2},{value:"Configuration Options",id:"configuration-options",level:2},{value:"expression",id:"expression",level:3},{value:"ResponseCodeRatio",id:"responsecoderatio",level:4},{value:"Using Multiple Metrics",id:"using-multiple-metrics",level:4},{value:"Operators",id:"operators",level:4},{value:"Fallback mechanism",id:"fallback-mechanism",level:3},{value:"State",id:"state",level:2},{value:"Closed",id:"closed",level:3},{value:"Open",id:"open",level:3},{value:"Recovering",id:"recovering",level:3}];function d(e){const t={a:"a",br:"br",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Circuit Breaker",src:r(1883).A+"",width:"2420",height:"419"})}),"\n",(0,n.jsx)(t.p,{children:"The HTTP circuit breaker prevents stacking requests to unhealthy Services, resulting in cascading failures."}),"\n",(0,n.jsx)(t.p,{children:"When your system is healthy, the circuit is closed (normal operations).\nWhen your system becomes unhealthy, the circuit opens, and the requests are no longer forwarded, but instead are handled by a fallback mechanism."}),"\n",(0,n.jsx)(t.p,{children:"To assess if your system is healthy, the circuit breaker constantly monitors the services."}),"\n",(0,n.jsxs)(t.p,{children:["The circuit breaker only analyzes what happens ",(0,n.jsx)(t.em,{children:"after"})," its position within the middleware chain. What happens ",(0,n.jsx)(t.em,{children:"before"})," has no impact on its state."]}),"\n",(0,n.jsx)(t.p,{children:"Each router gets its own instance of a given circuit breaker.\nOne circuit breaker instance can be open while the other remains closed: their state is not shared."}),"\n",(0,n.jsx)(t.p,{children:"This is the expected behavior, we want you to be able to define what makes a service healthy without having to declare a circuit breaker for each route."}),"\n",(0,n.jsx)(t.h2,{id:"configuration-examples",children:"Configuration Examples"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="Structured (YAML)"',children:'# Latency Check\nhttp:\n  middlewares:\n    latency-check:\n      circuitBreaker:\n        expression: "LatencyAtQuantileMS(50.0) > 100"\n'})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-toml",metastring:'tab="Structured (TOML)"',children:'# Latency Check\n[http.middlewares]\n  [http.middlewares.latency-check.circuitBreaker]\n    expression = "LatencyAtQuantileMS(50.0) > 100"\n'})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="Labels"',children:'# Latency Check\nlabels:\n  - "Mesh.http.middlewares.latency-check.circuitbreaker.expression=LatencyAtQuantileMS(50.0) > 100"\n'})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",metastring:'tab="Tags"',children:'{\n  //..\n  "Tags" : [\n    "Mesh.http.middlewares.latency-check.circuitbreaker.expression=LatencyAtQuantileMS(50.0) > 100"\n  ]\n}\n'})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="Kubernetes"',children:"# Latency Check\napiVersion: Mesh.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: latency-check\nspec:\n  circuitBreaker:\n    expression: LatencyAtQuantileMS(50.0) > 100\n"})}),"\n",(0,n.jsx)(t.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Field"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Default"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Required"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"expression"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Condition to open the circuit breaker and applies the fallback mechanism instead of calling your services.",(0,n.jsx)("br",{}),"More information ",(0,n.jsx)(t.a,{href:"#expression",children:"here"})]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"100ms"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"checkPeriod"})}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"The interval between successive checks of the circuit breaker condition (when in standby state)."}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"100ms"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"fallbackDuration"})}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"The duration for which the circuit breaker will wait before trying to recover (from a tripped state)."}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"10s"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"recoveryDuration"})}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"The duration for which the circuit breaker will try to recover (as soon as it is in recovering state)."}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"10s"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"responseCode"})}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"The status code that the circuit breaker will return while it is in the open state."}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"503"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]})]})]}),"\n",(0,n.jsx)(t.h3,{id:"expression",children:"expression"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"expression"})," option can check three different metrics:"]}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Metrics"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Example"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"NetworkErrorRatio"})}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"The network error ratio to open the circuit breaker."}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,n.jsx)(t.code,{children:"NetworkErrorRatio() > 0.30"})," opens the circuit breaker at a 30% ratio of network errors"]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"ResponseCodeRatio"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["The status code ratio to open the circuit breaker.",(0,n.jsx)("br",{}),"More information ",(0,n.jsx)(t.a,{href:"#responsecoderatio",children:"below"})]}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,n.jsx)(t.code,{children:"ResponseCodeRatio(500, 600, 0, 600) > 0.25"})," opens the circuit breaker if 25% of the requests returned a 5XX status (amongst the request that returned a status code from 0 to 5XX)"]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"LatencyAtQuantileMS"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["The latency at a quantile in milliseconds to open the circuit breaker when a given proportion of your requests become too slow.",(0,n.jsx)("br",{})," Only floating point number (with the trailing .0) for the quantile value."]}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,n.jsx)(t.code,{children:"LatencyAtQuantileMS(50.0) > 100"})," opens the circuit breaker when the median latency (quantile 50) reaches 100ms."]})]})]})]}),"\n",(0,n.jsx)(t.h4,{id:"responsecoderatio",children:"ResponseCodeRatio"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["It accepts four parameters, ",(0,n.jsx)(t.code,{children:"from"}),", ",(0,n.jsx)(t.code,{children:"to"}),", ",(0,n.jsx)(t.code,{children:"dividedByFrom"}),", ",(0,n.jsx)(t.code,{children:"dividedByTo"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:["The operation that will be computed is sum(",(0,n.jsx)(t.code,{children:"to"})," -> ",(0,n.jsx)(t.code,{children:"from"}),") / sum (",(0,n.jsx)(t.code,{children:"dividedByFrom"})," -> ",(0,n.jsx)(t.code,{children:"dividedByTo"}),"). If sum (",(0,n.jsx)(t.code,{children:"dividedByFrom"})," -> ",(0,n.jsx)(t.code,{children:"dividedByTo"}),") equals 0, then ",(0,n.jsx)(t.code,{children:"ResponseCodeRatio"})," returns 0."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"from"})," is inclusive, ",(0,n.jsx)(t.code,{children:"to"})," is exclusive."]}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"using-multiple-metrics",children:"Using Multiple Metrics"}),"\n",(0,n.jsxs)(t.p,{children:["You can combine multiple metrics using operators in your ",(0,n.jsx)(t.code,{children:"expression"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"Supported operators are:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["AND (",(0,n.jsx)(t.code,{children:"&&"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:["OR (",(0,n.jsx)(t.code,{children:"||"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["For example, ",(0,n.jsx)(t.code,{children:"ResponseCodeRatio(500, 600, 0, 600) > 0.30 || NetworkErrorRatio() > 0.10"})," triggers the circuit breaker when 30% of the requests return a 5XX status code, or when the ratio of network errors reaches 10%."]}),"\n",(0,n.jsx)(t.h4,{id:"operators",children:"Operators"}),"\n",(0,n.jsx)(t.p,{children:"Here is the list of supported operators:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Greater than (",(0,n.jsx)(t.code,{children:">"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:["Greater or equal than (",(0,n.jsx)(t.code,{children:">="}),")"]}),"\n",(0,n.jsxs)(t.li,{children:["Lesser than (",(0,n.jsx)(t.code,{children:"<"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:["Lesser or equal than (",(0,n.jsx)(t.code,{children:"<="}),")"]}),"\n",(0,n.jsxs)(t.li,{children:["Equal (",(0,n.jsx)(t.code,{children:"=="}),")"]}),"\n",(0,n.jsxs)(t.li,{children:["Not Equal (",(0,n.jsx)(t.code,{children:"!="}),")"]}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"fallback-mechanism",children:"Fallback mechanism"}),"\n",(0,n.jsxs)(t.p,{children:["The fallback mechanism returns a ",(0,n.jsx)(t.code,{children:"HTTP 503 Service Unavailable"})," to the client instead of calling the target service.",(0,n.jsx)(t.br,{}),"\n","This behavior cannot be configured."]}),"\n",(0,n.jsx)(t.h2,{id:"state",children:"State"}),"\n",(0,n.jsx)(t.p,{children:"There are three possible states for your circuit breaker:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"Closed"})," (your service operates normally)."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"Open"})," (the fallback mechanism takes over your service)."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"Recovering"})," (the circuit breaker tries to resume normal operations by progressively sending requests to your service)."]}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"closed",children:"Closed"}),"\n",(0,n.jsx)(t.p,{children:"While the circuit is closed, the circuit breaker only collects metrics to analyze the behavior of the requests."}),"\n",(0,n.jsxs)(t.p,{children:["At specified intervals (",(0,n.jsx)(t.code,{children:"checkPeriod"}),"), the circuit breaker evaluates ",(0,n.jsx)(t.code,{children:"expression"})," to decide if its state must change."]}),"\n",(0,n.jsx)(t.h3,{id:"open",children:"Open"}),"\n",(0,n.jsxs)(t.p,{children:["While open, the fallback mechanism takes over the normal service calls for a duration of ",(0,n.jsx)(t.code,{children:"FallbackDuration"}),".\nThe fallback mechanism returns a ",(0,n.jsx)(t.code,{children:"HTTP 503"})," (or ",(0,n.jsx)(t.code,{children:"ResponseCode"}),") to the client.\nAfter this duration, it enters the recovering state."]}),"\n",(0,n.jsx)(t.h3,{id:"recovering",children:"Recovering"}),"\n",(0,n.jsxs)(t.p,{children:["While recovering, the circuit breaker sends linearly increasing amounts of requests to your service (for ",(0,n.jsx)(t.code,{children:"RecoveryDuration"}),").\nIf your service fails during recovery, the circuit breaker opens again.\nIf the service operates normally during the entire recovery duration, then the circuit breaker closes."]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>c,x:()=>l});var i=r(6540);const n={},s=i.createContext(n);function c(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:c(e.components),i.createElement(s.Provider,{value:t},e.children)}}}]);