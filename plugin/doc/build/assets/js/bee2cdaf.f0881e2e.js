"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[6725],{2610:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"reference/install-configuration/providers/others/ecs","title":"Mesh AWS ECS Documentation","description":"Configuration discovery in Mesh is achieved through Providers. Read the technical documentation for leveraging AWS ECS in Mesh.","source":"@site/docs/reference/install-configuration/providers/others/ecs.md","sourceDirName":"reference/install-configuration/providers/others","slug":"/reference/install-configuration/providers/others/ecs","permalink":"/doc/docs/reference/install-configuration/providers/others/ecs","draft":false,"unlisted":false,"editUrl":"https://github.com/opendatav/mesh/tree/main/packages/create-docusaurus/templates/shared/docs/reference/install-configuration/providers/others/ecs.md","tags":[],"version":"current","frontMatter":{"title":"Mesh AWS ECS Documentation","description":"Configuration discovery in Mesh is achieved through Providers. Read the technical documentation for leveraging AWS ECS in Mesh."},"sidebar":"tutorialSidebar","previous":{"title":"Mesh ZooKeeper Documentation","permalink":"/doc/docs/reference/install-configuration/providers/kv/zk"},"next":{"title":"Mesh File Documentation","permalink":"/doc/docs/reference/install-configuration/providers/others/file"}}');var l=t(4848),i=t(8453);const r={title:"Mesh AWS ECS Documentation",description:"Configuration discovery in Mesh is achieved through Providers. Read the technical documentation for leveraging AWS ECS in Mesh."},a="Mesh & AWS ECS",c={},o=[{value:"Configuration Example",id:"configuration-example",level:2},{value:"Configuration Options",id:"configuration-options",level:2},{value:"<code>constraints</code>",id:"constraints",level:3},{value:"<code>defaultRule</code>",id:"defaultrule",level:3},{value:"Credentials",id:"credentials",level:3},{value:"Policy",id:"policy",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"mesh--aws-ecs",children:"Mesh & AWS ECS"})}),"\n",(0,l.jsx)(n.h2,{id:"configuration-example",children:"Configuration Example"}),"\n",(0,l.jsx)(n.p,{children:"You can enable the ECS provider with as detailed below:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"providers:\n  ecs: {}\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[providers.ecs]\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",metastring:'tab="CLI"',children:"--providers.ecs=true\n"})}),"\n",(0,l.jsx)(n.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{style:{textAlign:"left"},children:"Field"}),(0,l.jsx)(n.th,{style:{textAlign:"left"},children:"Description"}),(0,l.jsx)(n.th,{style:{textAlign:"left"},children:"Default"}),(0,l.jsx)(n.th,{style:{textAlign:"left"},children:"Required"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.providersThrottleDuration"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["Minimum amount of time to wait for, after a configuration reload, before taking into account any new configuration refresh event.",(0,l.jsx)("br",{}),"If multiple events occur within this time, only the most recent one is taken into account, and all others are discarded.",(0,l.jsx)("br",{}),(0,l.jsx)(n.strong,{children:"This option cannot be set per provider, but the throttling algorithm applies to each of them independently."})]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"2s"}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.autoDiscoverClusters"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["Search for services in cluster list. If set to ",(0,l.jsx)(n.code,{children:"true"})," service discovery is enabled for all clusters."]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"false"}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.ecsAnywhere"})}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"Enable ECS Anywhere support."}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"false"}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.clusters"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["Search for services in cluster list. This option is ignored if ",(0,l.jsx)(n.code,{children:"autoDiscoverClusters"})," is set to ",(0,l.jsx)(n.code,{children:"true"}),"."]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:'["default"]'})}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.exposedByDefault"})}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"Expose ECS services by default in Mesh."}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"true"}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.constraints"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines an expression that Mesh matches against the container labels to determine whether to create any route for that container. See ",(0,l.jsx)(n.a,{href:"#constraints",children:"here"})," for more information."]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"true"}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.healthyTasksOnly"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines whether Mesh discovers only healthy tasks (",(0,l.jsx)(n.code,{children:"HEALTHY"})," healthStatus)."]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"false"}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.defaultRule"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["The Default Host rule for all services. See ",(0,l.jsx)(n.a,{href:"#defaultrule",children:"here"})," for more information."]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:'"Host(`{{ normalize .Name }}`)"'})}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.refreshSeconds"})}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"Defines the polling interval (in seconds)."}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"15"}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.region"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines the region of the ECS instance. See ",(0,l.jsx)(n.a,{href:"#credentials",children:"here"})," for more information."]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:'""'}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.accessKeyID"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines the Access Key ID for the ECS instance. See ",(0,l.jsx)(n.a,{href:"#credentials",children:"here"})," for more information."]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:'""'}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{style:{textAlign:"left"},children:(0,l.jsx)(n.code,{children:"providers.ecs.secretAccessKey"})}),(0,l.jsxs)(n.td,{style:{textAlign:"left"},children:["Defines the Secret Access Key for the ECS instance. See ",(0,l.jsx)(n.a,{href:"#credentials",children:"here"})," for more information."]}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:'""'}),(0,l.jsx)(n.td,{style:{textAlign:"left"},children:"No"})]})]})]}),"\n",(0,l.jsx)(n.h3,{id:"constraints",children:(0,l.jsx)(n.code,{children:"constraints"})}),"\n",(0,l.jsxs)(n.p,{children:["The ",(0,l.jsx)(n.code,{children:"constraints"})," option can be set to an expression that Mesh matches against the container labels (task),\nto determine whether to create any route for that container.\nIf none of the container labels match the expression, no route for that container is created.\nIf the expression is empty, all detected containers are included."]}),"\n",(0,l.jsxs)(n.p,{children:["The expression syntax is based on the ",(0,l.jsx)(n.code,{children:'Label("key", "value")'}),", and ",(0,l.jsx)(n.code,{children:'LabelRegex("key", "value")'})," functions,\nas well as the usual boolean logic, as shown in examples below."]}),"\n",(0,l.jsx)(n.p,{children:'??? example "Constraints Expression Examples"'}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",children:'# Includes only containers having a label with key `a.label.name` and value `foo`\nconstraints = "Label(`a.label.name`, `foo`)"\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",children:'# Excludes containers having any label with key `a.label.name` and value `foo`\nconstraints = "!Label(`a.label.name`, `value`)"\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",children:'# With logical AND.\nconstraints = "Label(`a.label.name`, `valueA`) && Label(`another.label.name`, `valueB`)"\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",children:'# With logical OR.\nconstraints = "Label(`a.label.name`, `valueA`) || Label(`another.label.name`, `valueB`)"\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",children:'# With logical AND and OR, with precedence set by parentheses.\nconstraints = "Label(`a.label.name`, `valueA`) && (Label(`another.label.name`, `valueB`) || Label(`yet.another.label.name`, `valueC`))"\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",children:'# Includes only containers having a label with key `a.label.name` and a value matching the `a.+` regular expression.\nconstraints = "LabelRegex(`a.label.name`, `a.+`)"\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:'providers:\n  ecs:\n    constraints: "Label(`a.label.name`,`foo`)"\n    # ...\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[providers.ecs]\n  constraints = "Label(`a.label.name`,`foo`)"\n  # ...\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",metastring:'tab="CLI"',children:'--providers.ecs.constraints="Label(`a.label.name`,`foo`)"\n# ...\n'})}),"\n",(0,l.jsxs)(n.p,{children:["For additional information, refer to ",(0,l.jsx)(n.a,{href:"/doc/docs/reference/install-configuration/providers/overview#restrict-the-scope-of-service-discovery",children:"Restrict the Scope of Service Discovery"}),"."]}),"\n",(0,l.jsx)(n.h3,{id:"defaultrule",children:(0,l.jsx)(n.code,{children:"defaultRule"})}),"\n",(0,l.jsxs)(n.p,{children:["The ",(0,l.jsx)(n.code,{children:"defaultRule"})," option defines what routing rule to apply to a container if no rule is defined by a label."]}),"\n",(0,l.jsxs)(n.p,{children:["It must be a valid ",(0,l.jsx)(n.a,{href:"https://pkg.go.dev/text/template/",children:"Go template"}),", and can use\n",(0,l.jsx)(n.a,{href:"https://masterminds.github.io/sprig/",children:"sprig template functions"}),".\nThe container service name can be accessed with the ",(0,l.jsx)(n.code,{children:"Name"})," identifier,\nand the template has access to all the labels defined on this container."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:'providers:\n  ecs:\n    defaultRule: "Host(`{{ .Name }}.{{ index .Labels \\"customLabel\\"}}`)"\n    # ...\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[providers.ecs]\n  defaultRule = "Host(`{{ .Name }}.{{ index .Labels \\"customLabel\\"}}`)"\n  # ...\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",metastring:'tab="CLI"',children:"--providers.ecs.defaultRule='Host(`{{ .Name }}.{{ index .Labels \"customLabel\"}}`)'\n# ...\n"})}),"\n",(0,l.jsx)(n.p,{children:'??? info "Default rule and Mesh service"'}),"\n",(0,l.jsx)(n.p,{children:"The exposure of the Mesh container, combined with the default rule mechanism,\ncan lead to create a router targeting itself in a loop.\nIn this case, to prevent an infinite loop,\nMesh adds an internal middleware to refuse the request if it comes from the same router."}),"\n",(0,l.jsx)(n.h3,{id:"credentials",children:"Credentials"}),"\n",(0,l.jsx)(n.p,{children:"This defines the credentials for the ECS instance"}),"\n",(0,l.jsxs)(n.p,{children:["If ",(0,l.jsx)(n.code,{children:"region"})," is not provided, it is resolved from the EC2 metadata endpoint for EC2 tasks.\nIn a FARGATE context it is resolved from the ",(0,l.jsx)(n.code,{children:"AWS_REGION"})," environment variable."]}),"\n",(0,l.jsxs)(n.p,{children:["If ",(0,l.jsx)(n.code,{children:"accessKeyID"})," and ",(0,l.jsx)(n.code,{children:"secretAccessKey"})," are not provided, credentials are resolved in the following order:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Using the environment variables ",(0,l.jsx)(n.code,{children:"AWS_ACCESS_KEY_ID"}),", ",(0,l.jsx)(n.code,{children:"AWS_SECRET_ACCESS_KEY"}),", and ",(0,l.jsx)(n.code,{children:"AWS_SESSION_TOKEN"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Using shared credentials, determined by ",(0,l.jsx)(n.code,{children:"AWS_PROFILE"})," and ",(0,l.jsx)(n.code,{children:"AWS_SHARED_CREDENTIALS_FILE"}),", defaults to ",(0,l.jsx)(n.code,{children:"default"})," and ",(0,l.jsx)(n.code,{children:"~/.aws/credentials"}),"."]}),"\n",(0,l.jsx)(n.li,{children:"Using EC2 instance role or ECS task role"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:'providers:\n  ecs:\n    region: us-east-1\n    accessKeyID: "abc"\n    secretAccessKey: "123"\n    # ...\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[providers.ecs]\n  region = "us-east-1"\n  accessKeyID = "abc"\n  secretAccessKey = "123"\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",metastring:'tab="CLI"',children:'--providers.ecs.region="us-east-1"\n--providers.ecs.accessKeyID="abc"\n--providers.ecs.secretAccessKey="123"\n# ...\n'})}),"\n",(0,l.jsx)(n.h2,{id:"policy",children:"Policy"}),"\n",(0,l.jsx)(n.p,{children:"Mesh needs the following policy to read ECS information:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Sid": "MeshECSReadAccess",\n            "Effect": "Allow",\n            "Action": [\n                "ecs:ListClusters",\n                "ecs:DescribeClusters",\n                "ecs:ListTasks",\n                "ecs:DescribeTasks",\n                "ecs:DescribeContainerInstances",\n                "ecs:DescribeTaskDefinition",\n                "ec2:DescribeInstances",\n                "ssm:DescribeInstanceInformation"\n            ],\n            "Resource": [\n                "*"\n            ]\n        }\n    ]\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:'!!! info "ECS Anywhere"'}),"\n",(0,l.jsxs)(n.p,{children:["Please note that the ",(0,l.jsx)(n.code,{children:"ssm:DescribeInstanceInformation"})," action is required for ECS anywhere instances discovery."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var s=t(6540);const l={},i=s.createContext(l);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);