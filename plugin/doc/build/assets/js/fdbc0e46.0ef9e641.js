"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[3059],{5991:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"observability/metrics/prometheus","title":"Mesh Prometheus Documentation","description":"Mesh supports several metrics backends, including Prometheus. Learn how to implement it for observability in Mesh Proxy. Read the technical documentation.","source":"@site/docs/observability/metrics/prometheus.md","sourceDirName":"observability/metrics","slug":"/observability/metrics/prometheus","permalink":"/doc/docs/observability/metrics/prometheus","draft":false,"unlisted":false,"editUrl":"https://github.com/opendatav/mesh/tree/main/packages/create-docusaurus/templates/shared/docs/observability/metrics/prometheus.md","tags":[],"version":"current","frontMatter":{"title":"Mesh Prometheus Documentation","description":"Mesh supports several metrics backends, including Prometheus. Learn how to implement it for observability in Mesh Proxy. Read the technical documentation."},"sidebar":"tutorialSidebar","previous":{"title":"Mesh Metrics Overview","permalink":"/doc/docs/observability/metrics/overview"},"next":{"title":"Mesh StatsD Documentation","permalink":"/doc/docs/observability/metrics/statsd"}}');var r=n(4848),a=n(8453);const i={title:"Mesh Prometheus Documentation",description:"Mesh supports several metrics backends, including Prometheus. Learn how to implement it for observability in Mesh Proxy. Read the technical documentation."},l="Prometheus",c={},o=[{value:"<code>buckets</code>",id:"buckets",level:4},{value:"<code>addEntryPointsLabels</code>",id:"addentrypointslabels",level:4},{value:"<code>addRoutersLabels</code>",id:"addrouterslabels",level:4},{value:"<code>addServicesLabels</code>",id:"addserviceslabels",level:4},{value:"<code>entryPoint</code>",id:"entrypoint",level:4},{value:"<code>manualRouting</code>",id:"manualrouting",level:4},{value:"<code>headerLabels</code>",id:"headerlabels",level:4},{value:"Example",id:"example",level:5}];function d(e){const s={code:"code",em:"em",h1:"h1",h4:"h4",h5:"h5",header:"header",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"prometheus",children:"Prometheus"})}),"\n",(0,r.jsx)(s.p,{children:"To enable the Prometheus:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"metrics:\n  prometheus: {}\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[metrics]\n  [metrics.prometheus]\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--metrics.prometheus=true\n"})}),"\n",(0,r.jsx)(s.h4,{id:"buckets",children:(0,r.jsx)(s.code,{children:"buckets"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:'Optional, Default="0.100000, 0.300000, 1.200000, 5.000000"'})}),"\n",(0,r.jsx)(s.p,{children:"Buckets for latency metrics."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"metrics:\n  prometheus:\n    buckets:\n      - 0.1\n      - 0.3\n      - 1.2\n      - 5.0\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[metrics]\n  [metrics.prometheus]\n    buckets = [0.1,0.3,1.2,5.0]\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--metrics.prometheus.buckets=0.1,0.3,1.2,5.0\n"})}),"\n",(0,r.jsx)(s.h4,{id:"addentrypointslabels",children:(0,r.jsx)(s.code,{children:"addEntryPointsLabels"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:"Optional, Default=true"})}),"\n",(0,r.jsx)(s.p,{children:"Enable metrics on entry points."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"metrics:\n  prometheus:\n    addEntryPointsLabels: true\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[metrics]\n  [metrics.prometheus]\n    addEntryPointsLabels = true\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--metrics.prometheus.addEntryPointsLabels=true\n"})}),"\n",(0,r.jsx)(s.h4,{id:"addrouterslabels",children:(0,r.jsx)(s.code,{children:"addRoutersLabels"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:"Optional, Default=false"})}),"\n",(0,r.jsx)(s.p,{children:"Enable metrics on routers."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"metrics:\n  prometheus:\n    addRoutersLabels: true\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[metrics]\n  [metrics.prometheus]\n    addRoutersLabels = true\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--metrics.prometheus.addrouterslabels=true\n"})}),"\n",(0,r.jsx)(s.h4,{id:"addserviceslabels",children:(0,r.jsx)(s.code,{children:"addServicesLabels"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:"Optional, Default=true"})}),"\n",(0,r.jsx)(s.p,{children:"Enable metrics on services."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"metrics:\n  prometheus:\n    addServicesLabels: true\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[metrics]\n  [metrics.prometheus]\n    addServicesLabels = true\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--metrics.prometheus.addServicesLabels=true\n"})}),"\n",(0,r.jsx)(s.h4,{id:"entrypoint",children:(0,r.jsx)(s.code,{children:"entryPoint"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:"Optional, Default=Mesh"})}),"\n",(0,r.jsx)(s.p,{children:"Entry point used to expose metrics."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"entryPoints:\n  metrics:\n    address: :8082\n\nmetrics:\n  prometheus:\n    entryPoint: metrics\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[entryPoints]\n  [entryPoints.metrics]\n    address = ":8082"\n\n[metrics]\n  [metrics.prometheus]\n    entryPoint = "metrics"\n'})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--entryPoints.metrics.address=:8082\n--metrics.prometheus.entryPoint=metrics\n"})}),"\n",(0,r.jsx)(s.h4,{id:"manualrouting",children:(0,r.jsx)(s.code,{children:"manualRouting"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:"Optional, Default=false"})}),"\n",(0,r.jsxs)(s.p,{children:["If ",(0,r.jsx)(s.code,{children:"manualRouting"})," is ",(0,r.jsx)(s.code,{children:"true"}),", it disables the default internal router in order to allow one to create a custom router for the ",(0,r.jsx)(s.code,{children:"prometheus@internal"})," service."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"metrics:\n  prometheus:\n    manualRouting: true\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[metrics]\n  [metrics.prometheus]\n    manualRouting = true\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--metrics.prometheus.manualrouting=true\n"})}),"\n",(0,r.jsx)(s.h4,{id:"headerlabels",children:(0,r.jsx)(s.code,{children:"headerLabels"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:"Optional"})}),"\n",(0,r.jsxs)(s.p,{children:["Defines the extra labels for the ",(0,r.jsx)(s.code,{children:"requests_total"})," metrics, and for each of them, the request header containing the value for this label.\nPlease note that if the header is not present in the request it will be added nonetheless with an empty value.\nIn addition, the label should be a valid label name for Prometheus metrics,\notherwise, the Prometheus metrics provider will fail to serve any mesh-related metric."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"metrics:\n  prometheus:\n    headerLabels:\n      label: headerKey\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[metrics]\n  [metrics.prometheus]\n    [metrics.prometheus.headerLabels]\n      label = "headerKey"\n'})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--metrics.prometheus.headerlabels.label=headerKey\n"})}),"\n",(0,r.jsx)(s.h5,{id:"example",children:"Example"}),"\n",(0,r.jsxs)(s.p,{children:["Here is an example of the entryPoint ",(0,r.jsx)(s.code,{children:"requests_total"}),' metric with an additional "useragent" label.']}),"\n",(0,r.jsx)(s.p,{children:"When configuring the label in Static Configuration:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"metrics:\n  prometheus:\n    headerLabels:\n      useragent: User-Agent\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[metrics]\n  [metrics.prometheus]\n    [metrics.prometheus.headerLabels]\n      useragent = "User-Agent"\n'})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",metastring:'tab="CLI"',children:"--metrics.prometheus.headerlabels.useragent=User-Agent\n"})}),"\n",(0,r.jsx)(s.p,{children:"And performing a request with a custom User-Agent:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'curl -H "User-Agent: foobar" http://localhost\n'})}),"\n",(0,r.jsx)(s.p,{children:"The following metric is produced :"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'Mesh_entrypoint_requests_total{code="200",entrypoint="web",method="GET",protocol="http",useragent="foobar"} 1\n'})}),"\n",(0,r.jsxs)(s.p,{children:['!!! info "',(0,r.jsx)(s.code,{children:"Host"}),' header value"']}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"Host"})," header is never present in the Header map of a request, as per go documentation says:\n// For incoming requests, the Host header is promoted to the\n// Request.Host field and removed from the Header map."]}),"\n",(0,r.jsxs)(s.p,{children:["As a workaround, to obtain the Host of a request as a label, one should use instead the ",(0,r.jsx)(s.code,{children:"X-Forwarded-Host"})," header."]})]})}function h(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>l});var t=n(6540);const r={},a=t.createContext(r);function i(e){const s=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(a.Provider,{value:s},e.children)}}}]);