"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[61],{2032:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>a,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"reference/routing-configuration/http/middlewares/inflightreq","title":"Mesh InFlightReq Documentation","description":"Mesh Proxy\'s HTTP middleware lets you limit the number of simultaneous in-flight requests. Read the technical documentation.","source":"@site/docs/reference/routing-configuration/http/middlewares/inflightreq.md","sourceDirName":"reference/routing-configuration/http/middlewares","slug":"/reference/routing-configuration/http/middlewares/inflightreq","permalink":"/doc/docs/reference/routing-configuration/http/middlewares/inflightreq","draft":false,"unlisted":false,"editUrl":"https://github.com/opendatav/mesh/tree/main/packages/create-docusaurus/templates/shared/docs/reference/routing-configuration/http/middlewares/inflightreq.md","tags":[],"version":"current","frontMatter":{"title":"Mesh InFlightReq Documentation","description":"Mesh Proxy\'s HTTP middleware lets you limit the number of simultaneous in-flight requests. Read the technical documentation."},"sidebar":"tutorialSidebar","previous":{"title":"Mesh Headers Documentation","permalink":"/doc/docs/reference/routing-configuration/http/middlewares/headers"},"next":{"title":"Mesh HTTP Middlewares IPAllowList","permalink":"/doc/docs/reference/routing-configuration/http/middlewares/ipallowlist"}}');var n=i(4848),d=i(8453);const s={title:"Mesh InFlightReq Documentation",description:"Mesh Proxy's HTTP middleware lets you limit the number of simultaneous in-flight requests. Read the technical documentation."},l=void 0,o={},c=[{value:"Configuration Examples",id:"configuration-examples",level:2},{value:"Configuration Options",id:"configuration-options",level:2},{value:"sourceCriterion",id:"sourcecriterion",level:3},{value:"ipStrategy",id:"ipstrategy",level:3},{value:"<code>ipStrategy.ipv6Subnet</code>",id:"ipstrategyipv6subnet",level:3},{value:"Example of ipv6Subnet",id:"example-of-ipv6subnet",level:4},{value:"Example of Depth &amp; X-Forwarded-For",id:"example-of-depth--x-forwarded-for",level:3},{value:"Example of ExcludedIPs &amp; X-Forwarded-For",id:"example-of-excludedips--x-forwarded-for",level:3}];function h(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"inFlightReq"})," middleware proactively prevents services from being overwhelmed with high load."]}),"\n",(0,n.jsx)(t.h2,{id:"configuration-examples",children:"Configuration Examples"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="Structured (YAML)"',children:"# Limiting to 10 simultaneous connections\nhttp:\n  middlewares:\n    test-inflightreq:\n      inFlightReq:\n        amount: 10\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-toml",metastring:'tab="Structured (TOML)"',children:"# Limiting to 10 simultaneous connections\n[http.middlewares]\n  [http.middlewares.test-inflightreq.inFlightReq]\n    amount = 10\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="Labels"',children:'labels:\n  - "Mesh.http.middlewares.test-inflightreq.inflightreq.amount=10"\n'})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",metastring:'tab="Consul Catalog"',children:'// Limiting to 10 simultaneous connections\n{\n  "Tags" : [\n    "Mesh.http.middlewares.test-inflightreq.inflightreq.amount=10"\n  ]\n}\n\n'})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'tab="Kubernetes"',children:"apiVersion: Mesh.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: test-inflightreq\nspec:\n  inFlightReq:\n    amount: 10\n"})}),"\n",(0,n.jsx)(t.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Field"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Default"}),(0,n.jsx)(t.th,{style:{textAlign:"left"},children:"Required"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"amount"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["The ",(0,n.jsx)(t.code,{children:"amount"})," option defines the maximum amount of allowed simultaneous in-flight request. ",(0,n.jsx)("br",{})," The middleware responds with ",(0,n.jsx)(t.code,{children:"HTTP 429 Too Many Requests"})," if there are already ",(0,n.jsx)(t.code,{children:"amount"})," requests in progress (based on the same ",(0,n.jsx)(t.code,{children:"sourceCriterion"})," strategy)."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"0"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"sourceCriterion.requestHost"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Whether to consider the request host as the source.",(0,n.jsx)("br",{})," More information about ",(0,n.jsx)(t.code,{children:"sourceCriterion"}),(0,n.jsx)(t.a,{href:"#sourcecriterion",children:"here"}),"."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"false"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"sourceCriterion.requestHeaderName"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Name of the header used to group incoming requests.",(0,n.jsx)("br",{})," More information about ",(0,n.jsx)(t.code,{children:"sourceCriterion"}),(0,n.jsx)(t.a,{href:"#sourcecriterion",children:"here"}),"."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:'""'}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"sourceCriterion.ipStrategy.depth"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Depth position of the IP to select in the ",(0,n.jsx)(t.code,{children:"X-Forwarded-For"})," header (starting from the right).",(0,n.jsx)("br",{}),"0 means no depth.",(0,n.jsx)("br",{}),"If greater than the total number of IPs in ",(0,n.jsx)(t.code,{children:"X-Forwarded-For"}),", then the client IP is empty",(0,n.jsx)("br",{}),"If higher than 0, the ",(0,n.jsx)(t.code,{children:"excludedIPs"})," options is not evaluated.",(0,n.jsx)("br",{})," More information about ",(0,n.jsx)(t.a,{href:"#sourcecriterion",children:(0,n.jsx)(t.code,{children:"sourceCriterion"})}),", ",(0,n.jsxs)(t.a,{href:"#example-of-depth--x-forwarded-for",children:[(0,n.jsx)(t.code,{children:"ipStrategy](#ipstrategy), and ["}),"depth`"]})," below."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"0"}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"sourceCriterion.ipStrategy.excludedIPs"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["Allows Mesh to scan the ",(0,n.jsx)(t.code,{children:"X-Forwarded-For"})," header and select the first IP not in the list.",(0,n.jsx)("br",{}),"If ",(0,n.jsx)(t.code,{children:"depth"})," is specified, ",(0,n.jsx)(t.code,{children:"excludedIPs"})," is ignored.",(0,n.jsx)("br",{})," More information about ",(0,n.jsx)(t.a,{href:"#sourcecriterion",children:(0,n.jsx)(t.code,{children:"sourceCriterion"})}),", ",(0,n.jsxs)(t.a,{href:"#example-of-excludedips--x-forwarded-for",children:[(0,n.jsx)(t.code,{children:"ipStrategy](#ipstrategy), and ["}),"excludedIPs`"]})," below."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"}}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"left"},children:(0,n.jsx)(t.code,{children:"sourceCriterion.ipStrategy.ipv6Subnet"})}),(0,n.jsxs)(t.td,{style:{textAlign:"left"},children:["If ",(0,n.jsx)(t.code,{children:"ipv6Subnet"})," is provided and the selected IP is IPv6, the IP is transformed into the first IP of the subnet it belongs to. ",(0,n.jsx)("br",{})," More information about ",(0,n.jsx)(t.a,{href:"#sourcecriterion",children:(0,n.jsx)(t.code,{children:"sourceCriterion"})}),", ",(0,n.jsx)(t.a,{href:"#ipstrategyipv6subnet",children:(0,n.jsx)(t.code,{children:"ipStrategy.ipv6Subnet"})}),", and ",(0,n.jsx)(t.a,{href:"#example-of-excludedips--x-forwarded-for",children:(0,n.jsx)(t.code,{children:"excludedIPs"})})," below."]}),(0,n.jsx)(t.td,{style:{textAlign:"left"}}),(0,n.jsx)(t.td,{style:{textAlign:"left"},children:"No"})]})]})]}),"\n",(0,n.jsx)(t.h3,{id:"sourcecriterion",children:"sourceCriterion"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"sourceCriterion"})," option defines what criterion is used to group requests as originating from a common source.\nIf several strategies are defined at the same time, an error will be raised.\nIf none are set, the default is to use the ",(0,n.jsx)(t.code,{children:"requestHost"}),"."]}),"\n",(0,n.jsx)(t.h3,{id:"ipstrategy",children:"ipStrategy"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"ipStrategy"})," option defines three parameters that configures how Mesh determines the client IP: ",(0,n.jsx)(t.code,{children:"depth"}),", ",(0,n.jsx)(t.code,{children:"excludedIPs"})," and ",(0,n.jsx)(t.code,{children:"ipv6Subnet"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["As a middleware, ",(0,n.jsx)(t.code,{children:"inFlightReq"})," happens before the actual proxying to the backend takes place.\nIn addition, the previous network hop only gets appended to ",(0,n.jsx)(t.code,{children:"X-Forwarded-For"})," during the last stages of proxying, that is after it has already passed through the middleware.\nTherefore, during InFlightReq, as the previous network hop is not yet present in ",(0,n.jsx)(t.code,{children:"X-Forwarded-For"}),", it cannot be used and/or relied upon."]}),"\n",(0,n.jsx)(t.h3,{id:"ipstrategyipv6subnet",children:(0,n.jsx)(t.code,{children:"ipStrategy.ipv6Subnet"})}),"\n",(0,n.jsxs)(t.p,{children:["This strategy applies to ",(0,n.jsx)(t.code,{children:"Depth"})," and ",(0,n.jsx)(t.code,{children:"RemoteAddr"})," strategy only.\nIf ",(0,n.jsx)(t.code,{children:"ipv6Subnet"})," is provided and the selected IP is IPv6, the IP is transformed into the first IP of the subnet it belongs to."]}),"\n",(0,n.jsx)(t.p,{children:"This is useful for grouping IPv6 addresses into subnets to prevent bypassing this middleware by obtaining a new IPv6."}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"ipv6Subnet"})," is ignored if its value is outside 0-128 interval"]}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"example-of-ipv6subnet",children:"Example of ipv6Subnet"}),"\n",(0,n.jsxs)(t.p,{children:["If ",(0,n.jsx)(t.code,{children:"ipv6Subnet"})," is provided, the IP is transformed in the following way."]}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"IP"}),(0,n.jsx)(t.th,{children:"ipv6Subnet"}),(0,n.jsx)(t.th,{children:"clientIP"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"::abcd:1111:2222:3333"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"64"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"::0:0:0:0"'})})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"::abcd:1111:2222:3333"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"80"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"::abcd:0:0:0:0"'})})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"::abcd:1111:2222:3333"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"96"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"::abcd:1111:0:0:0"'})})]})]})]}),"\n",(0,n.jsx)(t.h3,{id:"example-of-depth--x-forwarded-for",children:"Example of Depth & X-Forwarded-For"}),"\n",(0,n.jsxs)(t.p,{children:["If ",(0,n.jsx)(t.code,{children:"depth"})," is set to 2, and the request ",(0,n.jsx)(t.code,{children:"X-Forwarded-For"})," header is ",(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1,12.0.0.1,13.0.0.1"'}),' then the "real" client IP is ',(0,n.jsx)(t.code,{children:'"10.0.0.1"'})," (at depth 4) but the IP used as the criterion is ",(0,n.jsx)(t.code,{children:'"12.0.0.1"'})," (",(0,n.jsx)(t.code,{children:"depth=2"}),")."]}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"X-Forwarded-For"}),(0,n.jsx)(t.th,{children:"depth"}),(0,n.jsx)(t.th,{children:"clientIP"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1,12.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"1"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"13.0.0.1"'})})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1,12.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"3"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"11.0.0.1"'})})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1,12.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"5"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'""'})})]})]})]}),"\n",(0,n.jsx)(t.h3,{id:"example-of-excludedips--x-forwarded-for",children:"Example of ExcludedIPs & X-Forwarded-For"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"X-Forwarded-For"}),(0,n.jsx)(t.th,{children:"excludedIPs"}),(0,n.jsx)(t.th,{children:"clientIP"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1,12.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"12.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"11.0.0.1"'})})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1,12.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"15.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"12.0.0.1"'})})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1,12.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"12.0.0.1"'})})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1,12.0.0.1,13.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"15.0.0.1,16.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"13.0.0.1"'})})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'"10.0.0.1,11.0.0.1"'})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:'""'})})]})]})]})]})}function a(e={}){const{wrapper:t}={...(0,d.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},8453:(e,t,i)=>{i.d(t,{R:()=>s,x:()=>l});var r=i(6540);const n={},d=r.createContext(n);function s(e){const t=r.useContext(d);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:s(e.components),r.createElement(d.Provider,{value:t},e.children)}}}]);