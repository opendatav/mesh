"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[1930],{2252:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/compress-2c83af265913608df63960f19f7943fe.png"},5615:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>r,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"middlewares/http/compress","title":"Mesh Compress Documentation","description":"Mesh Proxy\'s HTTP middleware lets you compress responses before sending them to the client. Read the technical documentation.","source":"@site/docs/middlewares/http/compress.md","sourceDirName":"middlewares/http","slug":"/middlewares/http/compress","permalink":"/doc/docs/middlewares/http/compress","draft":false,"unlisted":false,"editUrl":"https://github.com/opendatav/mesh/tree/main/packages/create-docusaurus/templates/shared/docs/middlewares/http/compress.md","tags":[],"version":"current","frontMatter":{"title":"Mesh Compress Documentation","description":"Mesh Proxy\'s HTTP middleware lets you compress responses before sending them to the client. Read the technical documentation."},"sidebar":"tutorialSidebar","previous":{"title":"Mesh CircuitBreaker Documentation","permalink":"/doc/docs/middlewares/http/circuitbreaker"},"next":{"title":"Mesh ContentType Documentation","permalink":"/doc/docs/middlewares/http/contenttype"}}');var d=s(4848),i=s(8453);const r={title:"Mesh Compress Documentation",description:"Mesh Proxy's HTTP middleware lets you compress responses before sending them to the client. Read the technical documentation."},c="Compress",a={},o=[{value:"Configuration Examples",id:"configuration-examples",level:2},{value:"Configuration Options",id:"configuration-options",level:2},{value:"<code>excludedContentTypes</code>",id:"excludedcontenttypes",level:3},{value:"<code>includedContentTypes</code>",id:"includedcontenttypes",level:3},{value:"<code>minResponseBodyBytes</code>",id:"minresponsebodybytes",level:3},{value:"<code>defaultEncoding</code>",id:"defaultencoding",level:3},{value:"<code>encodings</code>",id:"encodings",level:3}];function l(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"compress",children:"Compress"})}),"\n",(0,d.jsx)(n.p,{children:"Compress Allows Compressing Responses before Sending them to the Client"}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.img,{alt:"Compress",src:s(2252).A+"",width:"2420",height:"370"})}),"\n",(0,d.jsxs)(n.p,{children:["The Compress middleware supports Gzip, Brotli and Zstandard compression.\nThe activation of compression, and the compression method choice rely (among other things) on the request's ",(0,d.jsx)(n.code,{children:"Accept-Encoding"})," header."]}),"\n",(0,d.jsx)(n.h2,{id:"configuration-examples",children:"Configuration Examples"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Docker & Swarm"',children:'# Enable compression\nlabels:\n  - "Mesh.http.middlewares.test-compress.compress=true"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Kubernetes"',children:"# Enable compression\napiVersion: Mesh.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: test-compress\nspec:\n  compress: {}\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Consul Catalog"',children:'# Enable compression\n- "Mesh.http.middlewares.test-compress.compress=true"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"# Enable compression\nhttp:\n  middlewares:\n    test-compress:\n      compress: {}\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"# Enable compression\n[http.middlewares]\n  [http.middlewares.test-compress.compress]\n"})}),"\n",(0,d.jsx)(n.p,{children:"!!! info"}),"\n",(0,d.jsx)(n.p,{children:"Responses are compressed when the following criteria are all met:"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["The ",(0,d.jsx)(n.code,{children:"Accept-Encoding"})," request header contains ",(0,d.jsx)(n.code,{children:"gzip"}),", and/or ",(0,d.jsx)(n.code,{children:"*"}),", and/or ",(0,d.jsx)(n.code,{children:"br"}),", and/or ",(0,d.jsx)(n.code,{children:"zstd"})," with or without ",(0,d.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Glossary/Quality_values",children:"quality values"}),".\nIf the ",(0,d.jsx)(n.code,{children:"Accept-Encoding"})," request header is absent and no ",(0,d.jsx)(n.a,{href:"#defaultencoding",children:"defaultEncoding"})," is configured, the response won't be encoded.\nIf it is present, but its value is the empty string, then compression is disabled."]}),"\n",(0,d.jsxs)(n.li,{children:["The response is not already compressed, i.e. the ",(0,d.jsx)(n.code,{children:"Content-Encoding"})," response header is not already set."]}),"\n",(0,d.jsxs)(n.li,{children:["The response",(0,d.jsx)(n.code,{children:"Content-Type"})," header is not one among the ",(0,d.jsx)(n.a,{href:"#excludedcontenttypes",children:"excludedContentTypes options"}),", or is one among the ",(0,d.jsx)(n.a,{href:"#includedcontenttypes",children:"includedContentTypes options"}),"."]}),"\n",(0,d.jsxs)(n.li,{children:["The response body is larger than the ",(0,d.jsx)(n.a,{href:"#minresponsebodybytes",children:"configured minimum amount of bytes"})," (default is ",(0,d.jsx)(n.code,{children:"1024"}),")."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,d.jsx)(n.h3,{id:"excludedcontenttypes",children:(0,d.jsx)(n.code,{children:"excludedContentTypes"})}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.em,{children:'Optional, Default=""'})}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"excludedContentTypes"})," specifies a list of content types to compare the ",(0,d.jsx)(n.code,{children:"Content-Type"})," header of the incoming requests and responses before compressing."]}),"\n",(0,d.jsxs)(n.p,{children:["The responses with content types defined in ",(0,d.jsx)(n.code,{children:"excludedContentTypes"})," are not compressed."]}),"\n",(0,d.jsx)(n.p,{children:"Content types are compared in a case-insensitive, whitespace-ignored manner."}),"\n",(0,d.jsx)(n.p,{children:"!!! info"}),"\n",(0,d.jsxs)(n.p,{children:["The ",(0,d.jsx)(n.code,{children:"excludedContentTypes"})," and ",(0,d.jsx)(n.code,{children:"includedContentTypes"})," options are mutually exclusive."]}),"\n",(0,d.jsx)(n.p,{children:'!!! info "In the case of gzip"'}),"\n",(0,d.jsxs)(n.p,{children:["If the ",(0,d.jsx)(n.code,{children:"Content-Type"})," header is not defined, or empty, the compress middleware will automatically ",(0,d.jsx)(n.a,{href:"https://mimesniff.spec.whatwg.org/",children:"detect"})," a content type.\nIt will also set the ",(0,d.jsx)(n.code,{children:"Content-Type"})," header according to the detected MIME type."]}),"\n",(0,d.jsx)(n.p,{children:'!!! info "gRPC"'}),"\n",(0,d.jsxs)(n.p,{children:["Note that ",(0,d.jsx)(n.code,{children:"application/grpc"})," is never compressed."]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Docker & Swarm"',children:'labels:\n  - "Mesh.http.middlewares.test-compress.compress.excludedcontenttypes=text/event-stream"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Kubernetes"',children:"apiVersion: Mesh.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: test-compress\nspec:\n  compress:\n    excludedContentTypes:\n      - text/event-stream\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Consul Catalog"',children:'- "Mesh.http.middlewares.test-compress.compress.excludedcontenttypes=text/event-stream"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"http:\n  middlewares:\n    test-compress:\n      compress:\n        excludedContentTypes:\n          - text/event-stream\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[http.middlewares]\n  [http.middlewares.test-compress.compress]\n    excludedContentTypes = ["text/event-stream"]\n'})}),"\n",(0,d.jsx)(n.h3,{id:"includedcontenttypes",children:(0,d.jsx)(n.code,{children:"includedContentTypes"})}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.em,{children:'Optional, Default=""'})}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"includedContentTypes"})," specifies a list of content types to compare the ",(0,d.jsx)(n.code,{children:"Content-Type"})," header of the responses before compressing."]}),"\n",(0,d.jsxs)(n.p,{children:["The responses with content types defined in ",(0,d.jsx)(n.code,{children:"includedContentTypes"})," are compressed."]}),"\n",(0,d.jsx)(n.p,{children:"Content types are compared in a case-insensitive, whitespace-ignored manner."}),"\n",(0,d.jsx)(n.p,{children:"!!! info"}),"\n",(0,d.jsxs)(n.p,{children:["The ",(0,d.jsx)(n.code,{children:"excludedContentTypes"})," and ",(0,d.jsx)(n.code,{children:"includedContentTypes"})," options are mutually exclusive."]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Docker & Swarm"',children:'labels:\n  - "Mesh.http.middlewares.test-compress.compress.includedcontenttypes=application/json,text/html,text/plain"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Kubernetes"',children:"apiVersion: Mesh.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: test-compress\nspec:\n  compress:\n    includedContentTypes:\n      - application/json\n      - text/html\n      - text/plain\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Consul Catalog"',children:'- "Mesh.http.middlewares.test-compress.compress.includedcontenttypes=application/json,text/html,text/plain"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"http:\n  middlewares:\n    test-compress:\n      compress:\n        includedContentTypes:\n          - application/json\n          - text/html\n          - text/plain\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[http.middlewares]\n  [http.middlewares.test-compress.compress]\n    includedContentTypes = ["application/json","text/html","text/plain"]\n'})}),"\n",(0,d.jsx)(n.h3,{id:"minresponsebodybytes",children:(0,d.jsx)(n.code,{children:"minResponseBodyBytes"})}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.em,{children:"Optional, Default=1024"})}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"minResponseBodyBytes"})," specifies the minimum amount of bytes a response body must have to be compressed.\nResponses smaller than the specified values will not be compressed."]}),"\n",(0,d.jsx)(n.p,{children:'!!! tip "Streaming"'}),"\n",(0,d.jsxs)(n.p,{children:["When data is sent to the client on flush, the ",(0,d.jsx)(n.code,{children:"minResponseBodyBytes"})," configuration is ignored and the data is compressed.\nThis is particularly the case when data is streamed to the client when using ",(0,d.jsx)(n.code,{children:"Transfer-encoding: chunked"})," response."]}),"\n",(0,d.jsx)(n.p,{children:"When chunked data is sent to the client on flush, it will be compressed by default even if the received data has not reached"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Docker & Swarm"',children:'labels:\n  - "Mesh.http.middlewares.test-compress.compress.minresponsebodybytes=1200"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Kubernetes"',children:"apiVersion: Mesh.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: test-compress\nspec:\n  compress:\n    minResponseBodyBytes: 1200\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Consul Catalog"',children:'- "Mesh.http.middlewares.test-compress.compress.minresponsebodybytes=1200"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"http:\n  middlewares:\n    test-compress:\n      compress:\n        minResponseBodyBytes: 1200\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:"[http.middlewares]\n  [http.middlewares.test-compress.compress]\n    minResponseBodyBytes = 1200\n"})}),"\n",(0,d.jsx)(n.h3,{id:"defaultencoding",children:(0,d.jsx)(n.code,{children:"defaultEncoding"})}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.em,{children:'Optional, Default=""'})}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"defaultEncoding"})," specifies the default encoding if the ",(0,d.jsx)(n.code,{children:"Accept-Encoding"})," header is not in the request or contains a wildcard (",(0,d.jsx)(n.code,{children:"*"}),")."]}),"\n",(0,d.jsxs)(n.p,{children:["There is no fallback on the ",(0,d.jsx)(n.code,{children:"defaultEncoding"})," when the header value is empty or unsupported."]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Docker & Swarm"',children:'labels:\n  - "Mesh.http.middlewares.test-compress.compress.defaultEncoding=gzip"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Kubernetes"',children:"apiVersion: Mesh.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: test-compress\nspec:\n  compress:\n    defaultEncoding: gzip\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Consul Catalog"',children:'- "Mesh.http.middlewares.test-compress.compress.defaultEncoding=gzip"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"http:\n  middlewares:\n    test-compress:\n      compress:\n        defaultEncoding: gzip\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[http.middlewares]\n  [http.middlewares.test-compress.compress]\n    defaultEncoding = "gzip"\n'})}),"\n",(0,d.jsx)(n.h3,{id:"encodings",children:(0,d.jsx)(n.code,{children:"encodings"})}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.em,{children:'Optional, Default="gzip, br, zstd"'})}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"encodings"})," specifies the list of supported compression encodings.\nAt least one encoding value must be specified, and valid entries are ",(0,d.jsx)(n.code,{children:"gzip"})," (Gzip), ",(0,d.jsx)(n.code,{children:"br"})," (Brotli), and ",(0,d.jsx)(n.code,{children:"zstd"})," (Zstandard).\nThe order of the list also sets the priority, the top entry has the highest priority."]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Docker & Swarm"',children:'labels:\n  - "Mesh.http.middlewares.test-compress.compress.encodings=zstd,br"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Kubernetes"',children:"apiVersion: Mesh.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: test-compress\nspec:\n  compress:\n    encodings:\n      - zstd\n      - br\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="Consul Catalog"',children:'- "Mesh.http.middlewares.test-compress.compress.encodings=zstd,br"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",metastring:'tab="File (YAML)"',children:"http:\n  middlewares:\n    test-compress:\n      compress:\n        encodings:\n          - zstd\n          - br\n"})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-toml",metastring:'tab="File (TOML)"',children:'[http.middlewares]\n  [http.middlewares.test-compress.compress]\n    encodings = ["zstd","br"]\n'})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(l,{...e})}):l(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>c});var t=s(6540);const d={},i=t.createContext(d);function r(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:r(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);